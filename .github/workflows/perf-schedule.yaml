name: Network Performance Measurement on Schedule

on:
  schedule:
    # This is a cron expression that runs at 00:17 and 12:17 UTC
    - cron: '17 */12 * * *'

permissions:
  contents: read
  id-token: write

jobs:
  get-tag:
    name: Get Latest Release Tag
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Get latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(gh release view --repo ${{ github.repository }} --json tagName -q .tagName)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  perf-test-basic:
    needs: get-tag
    uses: ./.github/workflows/perf-template.yaml
    with:
      image-registry: ghcr.io
      tag: ${{ needs.get-tag.outputs.tag }}
      image-namespace: ${{ github.repository }}
      retina-mode: basic
      azure-location: ${{ vars.AZURE_LOCATION }}
    secrets:
      azure-subscription: ${{ secrets.AZURE_SUBSCRIPTION }}
      azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      azure-app-insights-key: ${{ secrets.AZURE_APP_INSIGHTS_KEY }}

  perf-test-advanced:
    needs: get-tag
    uses: ./.github/workflows/perf-template.yaml
    with:
      image-registry: ghcr.io
      tag: ${{ needs.get-tag.outputs.tag }}
      image-namespace: ${{ github.repository }}
      retina-mode: advanced
      azure-location: ${{ vars.AZURE_LOCATION }}
    secrets:
      azure-subscription: ${{ secrets.AZURE_SUBSCRIPTION }}
      azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      azure-app-insights-key: ${{ secrets.AZURE_APP_INSIGHTS_KEY }}
